<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ | ë¶€ì‚° ê°ˆë§·ê¸¸ 100M</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 120px 24px 40px;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: rgba(30, 41, 59, 0.5);
            padding: 24px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 8px;
        }
        .stat-label {
            color: #94a3b8;
            font-size: 0.875rem;
        }
        .scanner-container {
            max-width: 500px;
            margin: 0 auto 40px;
            overflow: hidden;
            border-radius: 12px;
            border: 2px solid #334155;
        }
        .tab-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }
        .tab-btn {
            padding: 10px 20px;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: #94a3b8;
            cursor: pointer;
        }
        .tab-btn.active {
            background: #ef4444;
            color: #fff;
            border-color: #ef4444;
        }
    </style>
</head>
<body>
    <nav class="nav-desktop">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">
                <span>ADMIN</span>
            </a>
            <div style="color:#94a3b8; font-size:0.9rem;">ê´€ë¦¬ì ëª¨ë“œ</div>
        </div>
    </nav>

    <div class="admin-container">
        <!-- Login Overlay -->
        <div id="login-overlay" style="position:fixed; inset:0; background:#0a0a0f; z-index:1000; display:flex; align-items:center; justify-content:center;">
            <div class="glass-card" style="padding:40px; width:100%; max-width:400px; text-align:center;">
                <h2 style="margin-bottom:24px;">ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
                <input type="password" id="admin-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="form-input" style="margin-bottom:16px;">
                <button onclick="checkAdmin()" class="btn-primary" style="width:100%;">ì ‘ì†</button>
            </div>
        </div>

        <div id="admin-content" style="display:none;">
            <h1 style="margin-bottom:32px;">ëŒ€íšŒ í˜„í™© ëŒ€ì‹œë³´ë“œ</h1>

            <!-- Stats -->
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-total">-</div>
                    <div class="stat-label">ì´ ì‹ ì²­ì</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-100m">-</div>
                    <div class="stat-label">100M ì‹ ì²­</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-50m">-</div>
                    <div class="stat-label">50M ì‹ ì²­</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-checked">-</div>
                    <div class="stat-label">í˜„ì¥ ì²´í¬ì¸ ì™„ë£Œ</div>
                </div>
            </div>

            <div class="tab-buttons">
                <button class="tab-btn active" onclick="showTab('scan')">QR ìŠ¤ìº”</button>
                <button class="tab-btn" onclick="showTab('list')">ì°¸ê°€ì ëª…ë‹¨</button>
            </div>

            <!-- QR Scanner Tab -->
            <div id="tab-scan">
                <div class="glass-card" style="padding:24px; text-align:center;">
                    <h3 style="margin-bottom:16px;">ğŸ“· QR ì²´í¬ì¸</h3>
                    <div class="scanner-container">
                        <div id="reader"></div>
                    </div>
                    <p id="scan-result" style="margin-top:16px; font-size:1.1rem; color:#ef4444; font-weight:bold; min-height:1.5em;"></p>
                </div>
            </div>

            <!-- List Tab -->
            <div id="tab-list" style="display:none;">
                <div class="glass-card" style="padding:24px;">
                    <h3 style="margin-bottom:16px;">ì°¸ê°€ì ëª©ë¡</h3>
                    <input type="text" id="search-participant" placeholder="ì´ë¦„ ë˜ëŠ” ì „í™”ë²ˆí˜¸ ê²€ìƒ‰" class="form-input" style="margin-bottom:16px;" onkeyup="filterList()">
                    <div style="overflow-x:auto;">
                        <table style="width:100%; border-collapse:collapse; color:#cbd5e1;">
                            <thead>
                                <tr style="border-bottom:1px solid #334155;">
                                    <th style="padding:12px; text-align:left;">ì´ë¦„</th>
                                    <th style="padding:12px; text-align:left;">ì½”ìŠ¤</th>
                                    <th style="padding:12px; text-align:left;">ì „í™”ë²ˆí˜¸</th>
                                    <th style="padding:12px; text-align:left;">ìƒíƒœ</th>
                                    <th style="padding:12px; text-align:right;">ì•¡ì…˜</th>
                                </tr>
                            </thead>
                            <tbody id="participant-list">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        // Simple client-side auth for demo (In production, verify with backend)
        function checkAdmin() {
            const pw = document.getElementById('admin-pw').value;
            if (pw === 'admin1234') { // Demo password
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                loadAdminData();
                startScanner();
            } else {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }

        let participants = [];

        async function loadAdminData() {
            // Fetch all registrations (requires admin action in backend)
            // Since we don't have a secure backend Auth, we will add a 'getAdminData' action
            // that checks a password sent in params (not secure for real Prod but ok for this demo level).

            try {
                const res = await fetchData('getAdminData', { password: 'admin_secret_key' });
                if (res && res.registrations) {
                    participants = res.registrations;
                    updateStats();
                    renderList();
                }
            } catch (e) {
                console.error(e);
                // Mock data if fetch fails
                participants = [
                    { name: 'ê¹€ì² ìˆ˜', course: '100M', phone: '010-1234-5678', status: 'ì‹ ì²­ì™„ë£Œ' },
                    { name: 'ì´ì˜í¬', course: '50M', phone: '010-9876-5432', status: 'ì²´í¬ì¸ì™„ë£Œ' }
                ];
                updateStats();
                renderList();
            }
        }

        function updateStats() {
            document.getElementById('stat-total').textContent = participants.length;
            document.getElementById('stat-100m').textContent = participants.filter(p => p.course === '100M').length;
            document.getElementById('stat-50m').textContent = participants.filter(p => p.course === '50M').length;
            document.getElementById('stat-checked').textContent = participants.filter(p => p.status === 'ì²´í¬ì¸ì™„ë£Œ').length;
        }

        function renderList() {
            const tbody = document.getElementById('participant-list');
            const search = document.getElementById('search-participant').value.toLowerCase();

            tbody.innerHTML = participants
                .filter(p => p.name.toLowerCase().includes(search) || p.phone.includes(search))
                .map((p, i) => `
                    <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                        <td style="padding:12px;">${p.name}</td>
                        <td style="padding:12px;">${p.course}</td>
                        <td style="padding:12px;">${p.phone}</td>
                        <td style="padding:12px;">
                            <span style="color:${p.status === 'ì²´í¬ì¸ì™„ë£Œ' ? '#22c55e' : '#94a3b8'}">${p.status}</span>
                        </td>
                        <td style="padding:12px; text-align:right;">
                            ${p.status !== 'ì²´í¬ì¸ì™„ë£Œ' ?
                                `<button onclick="checkIn('${p.name}', '${p.phone}')" class="btn-secondary" style="padding:4px 12px; font-size:0.8rem;">ì²´í¬ì¸</button>` :
                                ''}
                        </td>
                    </tr>
                `).join('');
        }

        function filterList() {
            renderList();
        }

        function showTab(tab) {
            document.getElementById('tab-scan').style.display = tab === 'scan' ? 'block' : 'none';
            document.getElementById('tab-list').style.display = tab === 'list' ? 'block' : 'none';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        async function checkIn(name, phone) {
            if (!confirm(`${name}ë‹˜ì„ ì²´í¬ì¸ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                // Call backend (POST)
                const res = await fetchData('updateStatus', { name, phone, status: 'ì²´í¬ì¸ì™„ë£Œ' }, 'POST');

                if (res.success) {
                    // Optimistic update
                    const p = participants.find(p => p.name === name && p.phone === phone);
                    if (p) {
                        p.status = 'ì²´í¬ì¸ì™„ë£Œ';
                        updateStats();
                        renderList();
                        alert(`${name}ë‹˜ ì²´í¬ì¸ ì™„ë£Œ`);
                    }
                } else {
                    alert('ì˜¤ë¥˜: ' + (res.error || 'ì—…ë°ì´íŠ¸ ì‹¤íŒ¨'));
                }
            } catch (e) {
                alert('í†µì‹  ì˜¤ë¥˜ ë°œìƒ');
                console.error(e);
            }
        }

        // Scanner
        function startScanner() {
            const html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess);
        }

        function onScanSuccess(decodedText, decodedResult) {
            // Assume QR code contains JSON: {"name":"í™ê¸¸ë™", "phone":"010-1234-5678"}
            try {
                const data = JSON.parse(decodedText);
                document.getElementById('scan-result').textContent = `ìŠ¤ìº”ë¨: ${data.name}`;
                checkIn(data.name, data.phone);
            } catch (e) {
                document.getElementById('scan-result').textContent = `QR í˜•ì‹ ì˜¤ë¥˜: ${decodedText}`;
            }
        }
    </script>
</body>
</html>